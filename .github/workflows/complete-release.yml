name: ðŸš€ Complete Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      custom_version:
        description: 'Custom version (optional, overrides version_type)'
        required: false
        type: string
      prerelease:
        description: 'Create prerelease'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'Skip tests (faster release)'
        required: false
        default: false
        type: boolean

jobs:
  complete-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
          cache-dependency-path: |
            webai-mcp/package-lock.json
            webai-server/package-lock.json

      - name: ðŸ”§ Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: ðŸ“ˆ Determine New Version
        id: version
        run: |
          cd webai-mcp
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          if [ -n "${{ github.event.inputs.custom_version }}" ]; then
            NEW_VERSION="${{ github.event.inputs.custom_version }}"
            echo "Using custom version: $NEW_VERSION"
          else
            # Use npm version to calculate new version
            npm version ${{ github.event.inputs.version_type }} --no-git-tag-version
            NEW_VERSION=$(node -p "require('./package.json').version")
            # Reset the change
            git checkout package.json
          fi

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "**Version Change:** $CURRENT_VERSION â†’ $NEW_VERSION" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“ˆ Bump All Versions
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          # Update MCP Server
          cd webai-mcp
          npm version $NEW_VERSION --no-git-tag-version

          # Update WebAI Server
          cd ../webai-server
          npm version $NEW_VERSION --no-git-tag-version

          # Update Chrome Extension
          cd ../chrome-extension
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
            manifest.version = '$NEW_VERSION';
            fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2) + '\n');
          "

          echo "âœ… All versions updated to $NEW_VERSION"

      - name: ðŸ”§ Install Dependencies
        run: |
          cd webai-mcp && npm ci
          cd ../webai-server && npm ci
          npm ci  # Install root dependencies for changelog automation

      - name: ðŸ—ï¸ Build Packages
        run: |
          cd webai-mcp && npm run build
          cd ../webai-server && npm run build

      - name: ðŸ§ª Run Tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          echo "ðŸ§ª Testing MCP Server..."
          cd webai-mcp
          timeout 10s node dist/mcp-server.js || echo "âœ… MCP Server test passed"

          echo "ðŸ§ª Testing WebAI Server..."
          cd ../webai-server
          timeout 5s node dist/browser-connector.js || echo "âœ… WebAI Server test passed"

          echo "ðŸ§ª Testing Chrome Extension..."
          cd ../chrome-extension
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
            if (!manifest.version || !manifest.name) throw new Error('Invalid manifest');
            console.log('âœ… Chrome Extension test passed');
          "

      - name: ðŸ“ Update Documentation and Changelog
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          # Update main README
          sed -i "s/v[0-9]\+\.[0-9]\+\.[0-9]\+/v$NEW_VERSION/g" README.md

          # Update MCP README if it exists
          if [ -f "webai-mcp/README.md" ]; then
            sed -i "s/v[0-9]\+\.[0-9]\+\.[0-9]\+/v$NEW_VERSION/g" webai-mcp/README.md
          fi

          # Update Chinese README if it exists
          if [ -f "docs/i18n/README_CN.md" ]; then
            sed -i "s/v[0-9]\+\.[0-9]\+\.[0-9]\+/v$NEW_VERSION/g" docs/i18n/README_CN.md
          fi

          # Generate production changelog entry
          TODAY=$(date +%Y-%m-%d)
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          # Get changes since last release
          if [ -n "$LAST_TAG" ]; then
            CHANGES=$(git log $LAST_TAG..HEAD --oneline --pretty=format:"- %s" --no-merges | grep -E "^- (feat|fix|docs|style|refactor|perf|test|chore|ci|build):" | head -20)
          else
            CHANGES=$(git log --oneline --pretty=format:"- %s" --no-merges | grep -E "^- (feat|fix|docs|style|refactor|perf|test|chore|ci|build):" | head -20)
          fi

          # Create production changelog entry
          cat > temp_changelog.md << EOF
          ## [${NEW_VERSION}] - ${TODAY}

          ### ðŸš€ **Production Release**

          #### **âœ¨ What's New**
          ${CHANGES}

          #### **ðŸ“¦ Installation**
          \`\`\`bash
          npx @cpjet64/webai-mcp@latest
          npx @cpjet64/webai-server@latest
          \`\`\`

          #### **ðŸ”— Links**
          - [GitHub Release](https://github.com/cpjet64/WebAI-MCP/releases/tag/v${NEW_VERSION})
          - [NPM Package (MCP)](https://www.npmjs.com/package/@cpjet64/webai-mcp)
          - [NPM Package (Server)](https://www.npmjs.com/package/@cpjet64/webai-server)

          ---

          EOF

          # Update CHANGELOG.md by replacing [Unreleased] with new version
          if grep -q "## \[Unreleased\]" CHANGELOG.md; then
            # Replace [Unreleased] with new version
            sed -i "s/## \[Unreleased\] - Development/## [${NEW_VERSION}] - ${TODAY}/" CHANGELOG.md

            # Add new [Unreleased] section at the top
            sed -i "/^## \[${NEW_VERSION}\]/i\\## [Unreleased] - Development\n\n### ðŸš€ **Future Features (In Development)**\n\nUpcoming features and improvements will be listed here.\n\n---\n" CHANGELOG.md
          else
            # No [Unreleased] section, prepend new release
            cat temp_changelog.md CHANGELOG.md > temp_full_changelog.md
            mv temp_full_changelog.md CHANGELOG.md
          fi

          rm -f temp_changelog.md

      - name: ðŸ’¾ Commit Version and Changelog Changes
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          git add .
          git commit -m "chore: release v$NEW_VERSION - automated release with version bump, changelog update, tests, and NPM publishing"

          git tag "v$NEW_VERSION"
          git push origin main
          git push origin "v$NEW_VERSION"

      - name: ðŸ“¦ Create Release Assets
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          # Create Chrome Extension Package
          cd chrome-extension
          zip -r ../webai-chrome-extension-v$NEW_VERSION.zip . \
            -x "*.git*" "node_modules/*" "*.DS_Store*"

          # Create NPM packages
          cd ../webai-mcp
          npm pack
          mv *.tgz ../webai-mcp-v$NEW_VERSION.tgz

          cd ../webai-server
          npm pack
          mv *.tgz ../webai-server-v$NEW_VERSION.tgz

      - name: ðŸ“ Generate Changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            CHANGELOG=$(git log $LAST_TAG..HEAD~1 --pretty=format:"- %s" --no-merges | head -20)
          else
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges | head -20)
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ðŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          name: "ðŸš€ WebAI-MCP v${{ steps.version.outputs.new_version }}"
          body: |
            # ðŸš€ WebAI-MCP v${{ steps.version.outputs.new_version }}

            ## ðŸ“‹ What's New

            ${{ steps.changelog.outputs.changelog }}

            ## ðŸ“¦ Installation

            ### Quick Start
            ```bash
            # Install MCP Server
            npx @cpjet64/webai-mcp@${{ steps.version.outputs.new_version }}

            # Install WebAI Server
            npx @cpjet64/webai-server@${{ steps.version.outputs.new_version }}
            ```

            ### Chrome Extension
            1. Download `webai-chrome-extension-v${{ steps.version.outputs.new_version }}.zip`
            2. Extract and load in Chrome â†’ Extensions â†’ Developer mode â†’ Load unpacked

            ## ðŸ› ï¸ Features

            - âœ… **17 MCP Tools** for browser automation
            - âœ… **Storage Access** - cookies, localStorage, sessionStorage
            - âœ… **Element Inspection** - CSS selectors + computed styles
            - âœ… **Enhanced Screenshots** - works with separate DevTools
            - âœ… **Audit & Debug Modes** - comprehensive analysis
            - âœ… **Windows Compatibility** - full cross-platform support
            - âœ… **Multi-language Documentation** - English + Chinese

            ## ðŸ”§ Compatibility

            - Node.js 18+ | Chrome/Chromium | Windows, macOS, Linux
            - MCP clients: Cursor, Claude Desktop, Cline, Zed

            ---

            ðŸ“š **Documentation**: [WebAI-MCP](https://github.com/cpjet64/WebAI-MCP)
            ðŸ› **Issues**: [Report bugs](https://github.com/cpjet64/WebAI-MCP/issues)
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            webai-chrome-extension-v${{ steps.version.outputs.new_version }}.zip
            webai-mcp-v${{ steps.version.outputs.new_version }}.tgz
            webai-server-v${{ steps.version.outputs.new_version }}.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¤ Publish to NPM
        if: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "ðŸš€ Publishing MCP Server to NPM..."
          cd webai-mcp
          npm publish --access public

          echo "ðŸš€ Publishing WebAI Server to NPM..."
          cd ../webai-server
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

      - name: âš ï¸ NPM Publishing Skipped
        if: ${{ !secrets.NPM_TOKEN }}
        run: |
          echo "âš ï¸ NPM publishing skipped - NPM_TOKEN secret not configured"
          echo "To enable NPM publishing, add NPM_TOKEN secret to repository settings"

      - name: ðŸŽ‰ Release Complete
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          echo "## ðŸŽ‰ Complete Release Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v$NEW_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ github.event.inputs.version_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Completed Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Version bumped and committed" >> $GITHUB_STEP_SUMMARY
          echo "- Tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub release created" >> $GITHUB_STEP_SUMMARY
          echo "- NPM packages published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Published Packages:" >> $GITHUB_STEP_SUMMARY
          echo "- [\`@cpjet64/webai-mcp@$NEW_VERSION\`](https://www.npmjs.com/package/@cpjet64/webai-mcp)" >> $GITHUB_STEP_SUMMARY
          echo "- [\`@cpjet64/webai-server@$NEW_VERSION\`](https://www.npmjs.com/package/@cpjet64/webai-server)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Installation:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npx @cpjet64/webai-mcp@$NEW_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "npx @cpjet64/webai-server@$NEW_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Release:** https://github.com/${{ github.repository }}/releases/tag/v$NEW_VERSION" >> $GITHUB_STEP_SUMMARY
